Template.registry.helpers({
    selectedRegistry: function(){
        return Session.get('registry:selected');
    }
});

Template.registry.events({
    'submit #create-new-registry': function (e, template) {

        e.preventDefault();

        var options = {
            from: Session.get('accounts:selected:address'),
            data: '6060604052610128806100126000396000f360606040526000357c0100000000000000000000000000000000000000000000000000000000900480634f2be91f146100445780635893253c1461005357610042565b005b61005160048050506100cd565b005b6100696004808035906020019091905050610095565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b600060005060205280600052604060002060009150909054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b3360006000506000600160005054815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555060016000818150548092919060010191905055505b56',
            gas: 3000000
        };

        securityRegistryContract.new(options, onRegistryCreated);

    },
    'submit #create-new-security': function (e, template) {

        e.preventDefault();

        var account = Session.get('accounts:selected:address');
        var quant = parseInt(template.find("input[name=quantity]").value);
        var registry = Session.get('registry:selected:address');

        var options = {
            from: account,
            data: '60606040526040516040806107c2833981016040528080519060200190919080519060200190919050505b8073ffffffffffffffffffffffffffffffffffffffff16634f2be91f604051817c01000000000000000000000000000000000000000000000000000000000281526004018090506000604051808303816000876161da5a03f1156100025750505081600360005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506000600081526020019081526020016000206000508190555033600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b50506106b2806101106000396000f36060604052361561008a576000357c0100000000000000000000000000000000000000000000000000000000900480630c3f6acf1461008c5780631d143848146100af5780632abdf5a8146100e85780636bdedcf01461012a5780638465eb301461015d578063ba1643c714610175578063cbf1304d146101b3578063fd380cb3146101e85761008a565b005b6100996004805050610646565b6040518082815260200191505060405180910390f35b6100bc6004805050610620565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6100fe600480803590602001909190505061064f565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61015b6004808035906020019091908035906020019091908035906020019091908035906020019091905050610512565b005b6101736004808035906020019091905050610433565b005b61019d6004808035906020019091908035906020019091908035906020019091905050610212565b6040518082815260200191505060405180910390f35b6101d26004808035906020019091908035906020019091905050610687565b6040518082815260200191505060405180910390f35b6102106004808035906020019091908035906020019091908035906020019091905050610318565b005b600082600360005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060008481526020019081526020016000206000505410156102685760009050610311565b82600360005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600084815260200190815260200160002060008282825054039250508190555082600360005060008673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600084815260200190815260200160002060008282825054019250508190555060019050610311565b9392505050565b82600360005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060008481526020019081526020016000206000505410156103685761042e565b6002600050600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663c52ab778338584604051847c0100000000000000000000000000000000000000000000000000000000028152600401808473ffffffffffffffffffffffffffffffffffffffff16815260200183815260200182815260200193505050506000604051808303816000876161da5a03f115610002575050505b505050565b3373ffffffffffffffffffffffffffffffffffffffff16600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561048f5761050f565b8073ffffffffffffffffffffffffffffffffffffffff1660026000506000600160005054815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145060016000818150548092919060010191905055505b50565b60006002600050600086815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561058457610619565b82600360005060008673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060008481526020019081526020016000206000505401905080600360005060008673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600084815260200190815260200160002060005081905550610619565b5050505050565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60016000505481565b600260005060205280600052604060002060009150909054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600360005060205281600052604060002060005060205280600052604060002060009150915050548156',
            gas: 3000000
        };

        securityContract.new(quant, registry, options, onSecurityCreated);

    }
});

/**
 * This method gets executed whenever new registry gets deployed to the blockchain.
 * @param err - Error object
 * @param contract - Contract object
 */
function onRegistryCreated(err, contract){

    if (err) {
        console.log(err.toString());
        return;
    }

    if (typeof contract.address != 'undefined') {
        console.log('Registry created: ' + contract.address);
        Session.set('registry:selected:address', contract.address);
    }

}

/**
 * This method gets executed whenever new security gets deployed to the blockchain.
 * @param err - Error object
 * @param contract - Contract object
 */
function onSecurityCreated(err, contract){

    if (err) {
        console.log(err.toString());
        return;
    }

    if (typeof contract.address != 'undefined') {
        console.log('Security created: ' + contract.address);
    }

}